# OrganADR Environment2 完整安装指南

## 系统要求

- **操作系统**: Ubuntu 22.04 (WSL2)
- **GPU**: NVIDIA RTX 4090 (或其他支持 CUDA 的 GPU)
- **Python**: 3.9
- **CUDA**: 11.7
- **PyTorch**: 2.0.0+cu117

---

## 第一部分：WSL2 环境准备

### 1. 安装 WSL2 Ubuntu 22.04

在 Windows PowerShell（管理员权限）中运行：
```powershell
# 安装 WSL2 Ubuntu 22.04
wsl --install -d Ubuntu-22.04

# 安装完成后重启电脑
shutdown /r /t 0
```

### 2. 首次启动 Ubuntu

- 在开始菜单找到 "Ubuntu 22.04 LTS" 并启动
- 创建用户（用户名必须小写，例如：`diana`）
- 设置密码

### 3. 验证 GPU 访问
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 验证 GPU 是否可见
nvidia-smi
```

如果看不到 GPU，需要安装 NVIDIA CUDA on WSL 驱动：
- 下载地址：https://developer.nvidia.com/cuda/wsl/download

---

## 第二部分：安装 Miniconda

### 1. 下载并安装
```bash
# 下载 Miniconda
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# 安装（一路回车和 yes）
bash Miniconda3-latest-Linux-x86_64.sh

# 重启 shell
source ~/.bashrc

# 验证安装
conda --version
```

### 2. 初始化 Conda
```bash
conda init bash
source ~/.bashrc
```

---

## 第三部分：安装 CUDA Toolkit
```bash
# 下载并安装 CUDA 密钥环
wget https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb

# 更新并安装 CUDA Toolkit 11.7
sudo apt-get update
sudo apt-get -y install cuda-toolkit-11-7

# 设置环境变量
echo 'export PATH=/usr/local/cuda-11.7/bin:$PATH' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc

# 验证 CUDA 安装
nvcc --version
```

应该显示：`Cuda compilation tools, release 11.7, V11.7.99`

---

## 第四部分：安装编译工具
```bash
# 安装 C++ 编译器和构建工具
sudo apt install -y build-essential g++ gcc dos2unix

# 验证安装
which g++
g++ --version
```

---

## 第五部分：复制项目到 WSL2
```bash
# 复制项目（Windows 的 C 盘在 WSL2 中是 /mnt/c）
cd ~
cp -r /mnt/c/DianaFile/tangCode/OrganADR ./

# 进入项目目录
cd ~/OrganADR
```

---

## 第六部分：创建 Environment2 环境

### 1. 进入安装脚本目录
```bash
cd ~/OrganADR/Part_01---To_Set_up_Necessary_Environment\(s\)---and---Download_Necessary_Files
```

### 2. 下载 PyTorch .whl 文件
```bash
# 创建 whls 目录
mkdir -p whls
cd whls

# 下载 Linux 版本的 .whl 文件
wget https://download.pytorch.org/whl/cu117/torch-2.0.0%2Bcu117-cp39-cp39-linux_x86_64.whl
wget https://data.pyg.org/whl/torch-2.0.0%2Bcu117/pyg_lib-0.4.0%2Bpt20cu117-cp39-cp39-linux_x86_64.whl
wget https://data.pyg.org/whl/torch-2.0.0%2Bcu117/torch_cluster-1.6.3%2Bpt20cu117-cp39-cp39-linux_x86_64.whl
wget https://data.pyg.org/whl/torch-2.0.0%2Bcu117/torch_sparse-0.6.18%2Bpt20cu117-cp39-cp39-linux_x86_64.whl
wget https://data.pyg.org/whl/torch-2.0.0%2Bcu117/torch_scatter-1.2.2%2Bpt20cu117-cp39-cp39-linux_x86_64.whl
wget https://data.pyg.org/whl/torch-2.0.0%2Bcu117/torch_spline_conv-1.2.2%2Bpt20cu117-cp39-cp39-linux_x86_64.whl

cd ..
```

### 3. 转换脚本格式（去除 Windows 换行符）
```bash
# 安装转换工具（如果还没安装）
sudo apt install dos2unix -y

# 转换脚本格式
dos2unix environment2.bash
```

### 4. 修改脚本中的 conda 路径
```bash
nano environment2.bash
```

确保第一行是：
```bash
source ~/miniconda3/etc/profile.d/conda.sh
```

保存：按 `Ctrl+X`，然后 `Y`，然后 `Enter`

### 5. 运行安装脚本
```bash
bash environment2.bash
```

### 6. 安装额外依赖
```bash
# 激活环境
conda activate environment2

# 降级 NumPy（重要！）
pip install "numpy<2"

# 安装 torchdrug
pip install torchdrug

# 安装其他依赖
conda install scikit-learn pandas matplotlib -y

# 验证安装
python -c "import torch; print('PyTorch:', torch.__version__); print('CUDA available:', torch.cuda.is_available())"
```

---

## 第七部分：修复训练脚本

### 1. 进入训练目录
```bash
cd ~/OrganADR/Part_02---Demo_of_Training_and_Evaluating_OrganADR/model
```

### 2. 修改 CUDA 路径（第 8 行）
```bash
nano train_and_evaluate_demo.py
```

找到第 8 行，将：
```python
cuda_path = r"C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1"
```

改为：
```python
cuda_path = "/usr/local/cuda-11.7"
```

### 3. 修改 GPU 架构版本（第 12 行）

找到第 12 行，将：
```python
os.environ.setdefault("TORCH_CUDA_ARCH_LIST", "8.9")
```

改为：
```python
os.environ.setdefault("TORCH_CUDA_ARCH_LIST", "8.6")
```

### 4. 删除 Windows 特定代码（第 48-49 行）

删除或注释掉这两行：
```python
# os.add_dll_directory(r"C:\Users\tangw\.conda\envs\organadr\Lib\site-packages\torch\lib")
# os.add_dll_directory(r"C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin")
```

保存文件。

---

## 第八部分：运行训练

### 1. 清除编译缓存
```bash
rm -rf ~/.cache/torch_extensions/*
```

### 2. 设置环境变量
```bash
export PATH=/usr/local/cuda-11.7/bin:/home/diana/miniconda3/envs/environment2/bin:/home/diana/miniconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib:/snap/bin
export CUDA_HOME=/usr/local/cuda-11.7
export CUDA_PATH=/usr/local/cuda-11.7
export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64
```

### 3. 激活环境并运行
```bash
conda activate environment2
python train_and_evaluate_demo.py --config ./config/demo.json
```

---

## 快速启动脚本

为方便日后使用，创建一个启动脚本：
```bash
cd ~/OrganADR/Part_02---Demo_of_Training_and_Evaluating_OrganADR/model

cat > run_train.sh << 'EOF'
#!/bin/bash

# 设置干净的环境
export PATH=/usr/local/cuda-11.7/bin:/home/diana/miniconda3/envs/environment2/bin:/home/diana/miniconda3/condabin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/usr/lib/wsl/lib:/snap/bin
export CUDA_HOME=/usr/local/cuda-11.7
export CUDA_PATH=/usr/local/cuda-11.7
export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64

# 激活环境
source ~/miniconda3/etc/profile.d/conda.sh
conda activate environment2

# 清除旧的编译缓存
rm -rf ~/.cache/torch_extensions/py39_cu117

# 运行训练
python train_and_evaluate_demo.py --config ./config/demo.json
EOF

chmod +x run_train.sh
```

以后直接运行：
```bash
./run_train.sh
```

---

## 常见问题与解决方案 (Q&A)

### Q1: WSL2 安装后显示代理警告

**问题**：
```
wsl: 检测到 localhost 代理配置，但未镜像到 WSL。NAT 模式下的 WSL 不支持 localhost 代理。
```

**解决方案**：
这个警告可以忽略，不影响使用。如果想消除警告，可以创建 `.wslconfig` 文件：
```powershell
# 在 Windows PowerShell 中
notepad $env:USERPROFILE\.wslconfig
```

添加内容：
```ini
[wsl2]
networkingMode=mirrored
dnsTunneling=true
firewall=true
autoProxy=true
```

保存后重启 WSL：
```powershell
wsl --shutdown
wsl -d Ubuntu-22.04
```

---

### Q2: conda init 时询问是否自动初始化

**问题**：
```
Do you wish to update your shell profile to automatically initialize conda?
```

**解决方案**：
输入 `yes` 并回车。这样每次打开终端时 conda 会自动准备好。

---

### Q3: 运行脚本时出现 `\r` 错误

**问题**：
```
environment2.bash: line 10: $'\r': command not found
```

**原因**：
脚本文件是 Windows 格式（CRLF 换行符），Linux 需要 Unix 格式（LF 换行符）。

**解决方案**：
```bash
sudo apt install dos2unix -y
dos2unix environment2.bash
```

---

### Q4: pip 安装 .whl 文件时报错 "not a supported wheel"

**问题**：
```
ERROR: torch-2.0.0+cu117-cp39-cp39-linux_x86_64.whl is not a supported wheel on this platform.
```

**原因**：
- Python 版本不匹配（需要 Python 3.9）
- 下载了 Windows 版本的 .whl 文件

**解决方案**：
1. 确认 Python 版本：
```bash
python --version  # 应该显示 Python 3.9.x
```

2. 确保下载的是 **Linux 版本**的 .whl 文件（文件名包含 `linux_x86_64`）

---

### Q5: NumPy 版本不兼容错误

**问题**：
```
AttributeError: _ARRAY_API not found
A module that was compiled using NumPy 1.x cannot be run in NumPy 2.0.1
```

**解决方案**：
```bash
conda activate environment2
pip install "numpy<2"
```

---

### Q6: 找不到 C++ 编译器

**问题**：
```
subprocess.CalledProcessError: Command '['which', 'c++']' returned non-zero exit status 1.
```

**解决方案**：
```bash
sudo apt install -y build-essential g++ gcc
which g++  # 验证安装
```

---

### Q7: CUDA 路径错误（Windows 路径）

**问题**：
```
-isystem C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1/include
c++: error: FilesNVIDIA: linker input file not found: No such file or directory
```

**原因**：
训练脚本中硬编码了 Windows CUDA 路径。

**解决方案**：
修改 `train_and_evaluate_demo.py` 第 8 行：
```python
# 修改前
cuda_path = r"C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1"

# 修改后
cuda_path = "/usr/local/cuda-11.7"
```

---

### Q8: GPU 架构不支持错误

**问题**：
```
nvcc fatal   : Unsupported gpu architecture 'compute_89'
```

**原因**：
RTX 4090 是 Ada Lovelace 架构（compute_89），但 CUDA 11.7 不支持。

**解决方案**：
修改 `train_and_evaluate_demo.py` 第 12 行：
```python
# 修改前
os.environ.setdefault("TORCH_CUDA_ARCH_LIST", "8.9")

# 修改后
os.environ.setdefault("TORCH_CUDA_ARCH_LIST", "8.6")
```

---

### Q9: os.add_dll_directory 错误

**问题**：
```
AttributeError: module 'os' has no attribute 'add_dll_directory'
```

**原因**：
`os.add_dll_directory` 是 Windows 专用函数，Linux 中不存在。

**解决方案**：
删除或注释掉 `train_and_evaluate_demo.py` 中的第 48-49 行：
```python
# os.add_dll_directory(r"C:\Users\tangw\.conda\envs\organadr\Lib\site-packages\torch\lib")
# os.add_dll_directory(r"C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin")
```

---

### Q10: 找不到 torchdrug 模块

**问题**：
```
ModuleNotFoundError: No module named 'torchdrug'
```

**原因**：
- 没有激活 `environment2` 环境
- 或者 torchdrug 没有安装

**解决方案**：
```bash
# 激活环境
conda activate environment2

# 验证当前环境
conda env list  # 应该看到 * 在 environment2 旁边

# 如果 torchdrug 未安装
pip install torchdrug
```

---

### Q11: CUDA 不可用

**问题**：
```python
torch.cuda.is_available()  # 返回 False
```

**解决方案**：
1. 验证 GPU 驱动：
```bash
nvidia-smi
```

2. 验证 CUDA 安装：
```bash
nvcc --version
```

3. 验证 PyTorch CUDA 版本：
```bash
python -c "import torch; print(torch.version.cuda)"
```

4. 如果以上都正常但仍不可用，可能需要重新安装 PyTorch：
```bash
pip uninstall torch -y
pip install torch-2.0.0+cu117-cp39-cp39-linux_x86_64.whl
```

---

### Q12: 每次打开终端都需要重新设置环境变量

**问题**：
每次打开新终端都要手动设置 CUDA_HOME 等环境变量。

**解决方案**：
将环境变量添加到 `~/.bashrc`：
```bash
cat >> ~/.bashrc << 'EOF'

# CUDA Environment
export PATH=/usr/local/cuda-11.7/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/cuda-11.7/lib64:$LD_LIBRARY_PATH
export CUDA_HOME=/usr/local/cuda-11.7
export CUDA_PATH=/usr/local/cuda-11.7
EOF

source ~/.bashrc
```

---

### Q13: Python 缓存导致代码修改不生效

**问题**：
修改了 Python 代码，但运行时仍然报旧的错误。

**解决方案**：
```bash
# 清除 Python 缓存
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
find . -type f -name "*.pyc" -delete

# 清除 PyTorch 扩展缓存
rm -rf ~/.cache/torch_extensions/*
```

---

### Q14: Windows 和 WSL2 文件同步问题

**问题**：
在 Windows 中修改了文件，但 WSL2 中运行的还是旧文件。

**原因**：
WSL2 中的项目是从 Windows 复制过来的**副本**，两者是独立的。

**解决方案**：
- **选项 1**：所有修改都在 WSL2 的 Ubuntu 中进行
- **选项 2**：修改后重新复制文件：
```bash
cp /mnt/c/DianaFile/tangCode/OrganADR/Part_02.../train_and_evaluate_demo.py ~/OrganADR/Part_02.../
```

**推荐**：直接在 WSL2 中工作，使用 `nano` 或 `vim` 编辑文件。

---

### Q15: 训练过程中 GPU 内存不足

**问题**：
```
RuntimeError: CUDA out of memory
```

**解决方案**：
修改配置文件 `config/demo.json`，减小 batch size：
```json
{
  "args": {
    "n_batch": 128,  // 改小这个值，例如 64 或 32
    "test_batch_size": 256  // 也可以改小
  }
}
```

---

## 环境验证清单

安装完成后，运行以下命令验证环境：
```bash
# 1. 验证 Python 版本
python --version  # 应该是 Python 3.9.x

# 2. 验证 Conda 环境
conda env list  # 应该看到 environment2

# 3. 验证 CUDA
nvcc --version  # 应该是 release 11.7

# 4. 验证 PyTorch
python -c "import torch; print('PyTorch:', torch.__version__, 'CUDA:', torch.cuda.is_available())"
# 应该显示: PyTorch: 2.0.0+cu117 CUDA: True

# 5. 验证 NumPy 版本
python -c "import numpy; print('NumPy:', numpy.__version__)"
# 应该是 1.x 版本，不能是 2.x

# 6. 验证 torchdrug
python -c "import torchdrug; print('torchdrug:', torchdrug.__version__)"

# 7. 验证 GPU
nvidia-smi
```

---

## 总结

完成以上步骤后，Environment2 应该已经成功配置。关键点：

1. ✅ WSL2 Ubuntu 22.04 环境
2. ✅ CUDA 11.7 正确安装
3. ✅ Python 3.9 + PyTorch 2.0.0+cu117
4. ✅ NumPy < 2.0
5. ✅ 训练脚本中的 CUDA 路径和 GPU 架构已修复
6. ✅ 所有 Windows 特定代码已删除

现在可以开始训练模型了！
```bash
conda activate environment2
cd ~/OrganADR/Part_02---Demo_of_Training_and_Evaluating_OrganADR/model
python train_and_evaluate_demo.py --config ./config/demo.json
```

---

## 附录：常用命令
```bash
# 激活环境
conda activate environment2

# 退出环境
conda deactivate

# 查看已安装的包
pip list
conda list

# 查看 CUDA 相关环境变量
env | grep -i cuda

# 清除编译缓存
rm -rf ~/.cache/torch_extensions/*

# 查看 GPU 使用情况
nvidia-smi
watch -n 1 nvidia-smi  # 实时监控

# WSL2 相关
wsl --list --verbose  # 查看 WSL2 状态
wsl --shutdown  # 关闭 WSL2
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-03  
**适用系统**: Windows 11 + WSL2 Ubuntu 22.04 + NVIDIA RTX 4090